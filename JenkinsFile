pipeline {
	agent any
	tools {
		maven "MAVEN3"
		jdk "OracleJDK11"
	}
	environment {
		registryCred = 'ACRTANMAY'
		registryURL = "tanmayregistry.azurecr.io"
		appRegistry = "tanmayregistry.azurecr.io/bookpp"
	}
	stages {
		stage ('Fetch') {
			steps {
				git branch: 'docker' , url: 'https://github.com/ptanmay0071/onlinebookstore.git'
			}
		}
		stage('BUILD'){
            steps {
                sh 'mvn install'
            }
            post {
                success {
                    echo 'Now Archiving...'
                    archiveArtifacts artifacts: '**/target/*.war'
                }
            }
        }
		stage ('Unit_Test'){
			steps{
				sh 'mvn test'
			}
		}
		stage('Build App Image') {
          steps {
            script {
              dockerImage = docker.build appRegistry + ":V$BUILD_NUMBER"
            }
          }
        }
		stage('PUSH'){
			steps{
				script{
					docker.withRegistry( "https://${registryURL}" , registryCred){
						dockerImage.push("$BUILD_NUMBER")
               			dockerImage.push('latest')
					}
				}
			}
		}
	}
}